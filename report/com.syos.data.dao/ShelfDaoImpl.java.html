<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShelfDaoImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SYOS Coverage</a> &gt; <a href="index.source.html" class="el_package">com.syos.data.dao</a> &gt; <span class="el_source">ShelfDaoImpl.java</span></div><h1>ShelfDaoImpl.java</h1><pre class="source lang-java linenums">package com.syos.data.dao;

import com.syos.application.dto.LowStockEventDTO;
import com.syos.application.dto.ReshelvedItemDTO;
import com.syos.data.dao.interfaces.ShelfDao;
import com.syos.domain.entity.Shelf;
import com.syos.domain.entity.ShelfInventory;
import com.syos.domain.entity.StockStatus;
import com.syos.utils.SQLTransactionManager;

import java.sql.*;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

<span class="nc" id="L17">public class ShelfDaoImpl implements ShelfDao {</span>

    @Override
    public void save(Connection conn, Shelf shelf) throws SQLException {
<span class="nc" id="L21">        String sql = &quot;INSERT INTO Shelf (shelfId, itemCode, quantityOnShelf, location, status, updatedBy, updatedAt) &quot; +</span>
                &quot;VALUES (?, ?, ?, ?, ?, ?, ?)&quot;;
<span class="nc" id="L23">        try (PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L24">            stmt.setString(1, shelf.getShelfId());</span>
<span class="nc" id="L25">            stmt.setString(2, shelf.getItemCode());</span>
<span class="nc" id="L26">            stmt.setInt(3, shelf.getQuantityOnShelf());</span>
<span class="nc" id="L27">            stmt.setString(4, shelf.getLocation());</span>
<span class="nc" id="L28">            stmt.setString(5, shelf.getStatus().name());</span>
<span class="nc" id="L29">            stmt.setString(6, shelf.getUpdatedBy());</span>
<span class="nc" id="L30">            stmt.setObject(7, shelf.getUpdatedAt());</span>
<span class="nc" id="L31">            stmt.executeUpdate();</span>
        }
<span class="nc" id="L33">    }</span>

    @Override
    public boolean exists(Connection conn, String location) throws SQLException {
<span class="nc" id="L37">        String sql = &quot;SELECT COUNT(*) FROM Shelf WHERE location = ?&quot;;</span>
<span class="nc" id="L38">        try (PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L39">            stmt.setString(1, location);</span>
<span class="nc" id="L40">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L41" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc bnc" id="L42" title="All 2 branches missed.">                    return rs.getInt(1) &gt; 0;</span>
                }
<span class="nc bnc" id="L44" title="All 2 branches missed.">            }</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">        }</span>
<span class="nc" id="L46">        return false;</span>
    }

    @Override
    public void logShelfRestockTransaction(Connection conn, String itemCode, String batchCode, int quantity, String shelfId, String updatedBy) throws SQLException {
<span class="nc" id="L51">        String sql = &quot;INSERT INTO ShelfInventory (ItemCode, BatchCode, ShelfId, QuantityTransferred, QuantityRemaining, MovedDate, Status, UpdatedBy) &quot; +</span>
                &quot;VALUES (?, ?, ?, ?, ?, ?, ?, ?)&quot;;
<span class="nc" id="L53">        try (PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L54">            stmt.setString(1, itemCode);</span>
<span class="nc" id="L55">            stmt.setString(2, batchCode);</span>
<span class="nc" id="L56">            stmt.setString(3, shelfId);</span>
<span class="nc" id="L57">            stmt.setInt(4, quantity);</span>
<span class="nc" id="L58">            stmt.setInt(5, quantity);</span>
<span class="nc" id="L59">            stmt.setObject(6, LocalDateTime.now());</span>
<span class="nc" id="L60">            stmt.setString(7, StockStatus.ACTIVE.name());</span>
<span class="nc" id="L61">            stmt.setString(8, updatedBy);</span>
<span class="nc" id="L62">            stmt.executeUpdate();</span>
        }

<span class="nc" id="L65">    }</span>

    @Override
    public List&lt;ShelfInventory&gt; findActiveBatches(Connection conn, String itemCode) throws SQLException {
<span class="nc" id="L69">        String sql = &quot;SELECT * FROM ShelfInventory &quot; +</span>
                &quot;WHERE itemCode = ? AND status = 'ACTIVE'&quot;;

<span class="nc" id="L72">        try (PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L73">            stmt.setString(1, itemCode);</span>
<span class="nc" id="L74">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc" id="L75">                List&lt;ShelfInventory&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L77">                    result.add(mapResultSetToShelfInventory(rs));</span>
                }
<span class="nc" id="L79">                return result;</span>
            }
        }
    }

    @Override
    public Optional&lt;LowStockEventDTO&gt; getTriggeredLowStockEvent(Connection conn, String itemCode) throws SQLException {
<span class="nc" id="L86">        String sql = &quot;&quot;&quot;</span>
        SELECT 
            p.itemCode,
            p.itemName,
            COALESCE(SUM(CASE WHEN si.status = 'ACTIVE' THEN si.quantityRemaining ELSE 0 END), 0) AS currentQuantity
        FROM 
            Product p
        LEFT JOIN 
            ShelfInventory si ON p.itemCode = si.itemCode
        WHERE 
            p.itemCode = ?
        GROUP BY 
            p.itemCode, p.itemName, p.reorderLevel
        HAVING 
            currentQuantity &lt; p.reorderLevel
    &quot;&quot;&quot;;

<span class="nc" id="L103">        try (PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L104">            stmt.setString(1, itemCode);</span>

<span class="nc" id="L106">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc" id="L108">                    return Optional.of(new LowStockEventDTO(</span>
<span class="nc" id="L109">                            rs.getString(&quot;itemCode&quot;),</span>
<span class="nc" id="L110">                            rs.getString(&quot;itemName&quot;),</span>
<span class="nc" id="L111">                            rs.getInt(&quot;currentQuantity&quot;)</span>
                    ));
                } else {
<span class="nc" id="L114">                    return Optional.empty();</span>
                }
<span class="nc bnc" id="L116" title="All 2 branches missed.">            }</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        }</span>
    }

    @Override
    public void update(Connection conn, ShelfInventory batch) throws SQLException {
<span class="nc" id="L122">        String sql = &quot;UPDATE ShelfInventory SET quantityRemaining = ?, status = ? &quot; +</span>
                &quot;WHERE itemCode = ? AND batchCode = ? AND shelfId = ?&quot;;

<span class="nc" id="L125">        try (PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L126">            stmt.setInt(1, batch.getQuantityRemaining());</span>
<span class="nc" id="L127">            stmt.setString(2, batch.getStatus().name());</span>
<span class="nc" id="L128">            stmt.setString(3, batch.getItemCode());</span>
<span class="nc" id="L129">            stmt.setString(4, batch.getBatchCode());</span>
<span class="nc" id="L130">            stmt.setString(5, batch.getShelfId());</span>
<span class="nc" id="L131">            stmt.executeUpdate();</span>
        }
<span class="nc" id="L133">    }</span>

    private ShelfInventory mapResultSetToShelfInventory(ResultSet rs) throws SQLException {
<span class="nc" id="L136">        ShelfInventory inventory = new ShelfInventory();</span>
<span class="nc" id="L137">        inventory.setItemCode(rs.getString(&quot;itemCode&quot;));</span>
<span class="nc" id="L138">        inventory.setBatchCode(rs.getString(&quot;batchCode&quot;));</span>
<span class="nc" id="L139">        inventory.setShelfId(rs.getString(&quot;shelfId&quot;));</span>
<span class="nc" id="L140">        inventory.setQuantityRemaining(rs.getInt(&quot;quantityRemaining&quot;));</span>
<span class="nc" id="L141">        inventory.setStatus(StockStatus.valueOf(rs.getString(&quot;status&quot;)));</span>
<span class="nc" id="L142">        return inventory;</span>
    }

    @Override
    public List&lt;ReshelvedItemDTO&gt; fetchItemsPendingReshelving() throws SQLException {
<span class="nc" id="L147">        return SQLTransactionManager.execute(conn -&gt; {</span>
<span class="nc" id="L148">            String sql = &quot;&quot;&quot;</span>
            SELECT 
                si.itemCode,
                p.itemName,
                sh.quantityOnShelf AS shelfCapacity,
                SUM(CASE WHEN si.status = 'ACTIVE' THEN si.quantityRemaining ELSE 0 END) AS currentQuantity,
                SUM(CASE WHEN si.status = 'EXPIRED' THEN si.quantityRemaining ELSE 0 END) AS expiredQuantity,
                SUM(si.quantityTransferred - si.quantityRemaining) AS soldQuantity,
                (sh.quantityOnShelf - SUM(CASE WHEN si.status = 'ACTIVE' THEN si.quantityRemaining ELSE 0 END)) AS toBeReshelved,
                MAX(si.movedDate) AS lastMovedDate
            FROM 
                ShelfInventory si
            JOIN 
                Shelf sh ON si.shelfId = sh.shelfId
            JOIN 
                Product p ON si.itemCode = p.itemCode
            GROUP BY 
                si.itemCode, p.itemName, sh.quantityOnShelf
            HAVING 
                toBeReshelved &gt; 0
            ORDER BY 
                toBeReshelved DESC
        &quot;&quot;&quot;;

<span class="nc" id="L172">            List&lt;ReshelvedItemDTO&gt; results = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L173">            try (PreparedStatement stmt = conn.prepareStatement(sql);</span>
<span class="nc" id="L174">                 ResultSet rs = stmt.executeQuery()) {</span>

<span class="nc bnc" id="L176" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L177">                    ReshelvedItemDTO item = new ReshelvedItemDTO();</span>
<span class="nc" id="L178">                    item.setItemCode(rs.getString(&quot;itemCode&quot;));</span>
<span class="nc" id="L179">                    item.setItemName(rs.getString(&quot;itemName&quot;));</span>
<span class="nc" id="L180">                    item.setShelfCapacity(rs.getInt(&quot;shelfCapacity&quot;));</span>
<span class="nc" id="L181">                    item.setCurrentQuantity(rs.getInt(&quot;currentQuantity&quot;));</span>
<span class="nc" id="L182">                    item.setExpiredQuantity(rs.getInt(&quot;expiredQuantity&quot;));</span>
<span class="nc" id="L183">                    item.setSoldQuantity(rs.getInt(&quot;soldQuantity&quot;));</span>
<span class="nc" id="L184">                    item.setToBeReshelved(rs.getInt(&quot;toBeReshelved&quot;));</span>
<span class="nc" id="L185">                    item.setLastMovedDate(rs.getDate(&quot;lastMovedDate&quot;).toLocalDate());</span>

<span class="nc" id="L187">                    results.add(item);</span>
<span class="nc" id="L188">                }</span>
            }

<span class="nc" id="L191">            return results;</span>
        });
    }
}

//    @Override
//    public List&lt;ReshelvedItemDTO&gt; fetchItemsPendingReshelving() throws SQLException {
//        return SQLTransactionManager.execute(conn -&gt; {
//            String sql = &quot;&quot;&quot;
//                        SELECT
//                            si.itemCode,
//                            p.itemName,
//                            sh.quantityOnShelf AS shelfCapacity,
//                            SUM(si.quantityRemaining) AS currentQuantity,
//                            (sh.quantityOnShelf - SUM(si.quantityRemaining)) AS toBeReshelved,
//                            MAX(si.movedDate) AS lastMovedDate
//                        FROM
//                            ShelfInventory si
//                        JOIN
//                            Shelf sh ON si.shelfId = sh.shelfId
//                        JOIN
//                            Product p ON si.itemCode = p.itemCode
//                        WHERE
//                            si.status = 'ACTIVE'
//                        GROUP BY
//                            si.itemCode, p.itemName, sh.quantityOnShelf
//                        HAVING
//                            toBeReshelved &gt; 0
//                        ORDER BY
//                            toBeReshelved DESC
//                    &quot;&quot;&quot;;
//
//            List&lt;ReshelvedItemDTO&gt; results = new ArrayList&lt;&gt;();
//            try (PreparedStatement stmt = conn.prepareStatement(sql);
//                 ResultSet rs = stmt.executeQuery()) {
//
//                while (rs.next()) {
//                    ReshelvedItemDTO item = new ReshelvedItemDTO();
//                    item.setItemCode(rs.getString(&quot;itemCode&quot;));
//                    item.setItemName(rs.getString(&quot;itemName&quot;));
//                    item.setShelfCapacity(rs.getInt(&quot;shelfCapacity&quot;));
//                    item.setCurrentQuantity(rs.getInt(&quot;currentQuantity&quot;));
//                    item.setToBeReshelved(rs.getInt(&quot;toBeReshelved&quot;));
//                    item.setLastMovedDate(rs.getDate(&quot;lastMovedDate&quot;).toLocalDate());
//
//                    results.add(item);
//                }
//            }
//
//            return results;
//        });
//    }

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>